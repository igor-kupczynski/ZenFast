# ZenFast Technical Design Document

## Overview

This document outlines the technical implementation of ZenFast, a Telegram bot for small groups of trusted users. The design prioritizes simplicity and follows YAGNI (You Aren't Gonna Need It) principles.

**Reference**: Product Requirements Document - `/specs/prd-001.md`

## Architecture

### Platform
- **Runtime**: Cloudflare Workers
- **Storage**: Cloudflare Workers KV
- **Language**: JavaScript/TypeScript
- **External Dependencies**: Telegram Bot API only

### System Components

```
┌─────────────────┐     HTTPS      ┌──────────────────┐
│ Telegram Users  │ ◄────────────► │ Telegram Servers │
└─────────────────┘                 └────────┬─────────┘
                                             │ Webhook
                                             ▼
                                    ┌────────────────────┐
                                    │ Cloudflare Worker  │
                                    │   (ZenFast Bot)    │
                                    └────────┬───────────┘
                                             │
                              ┌──────────────┴──────────────┐
                              ▼                             ▼
                      ┌───────────────┐            ┌────────────────┐
                      │ API_KEYS (KV) │            │ CHATS (KV)     │
                      └───────────────┘            └────────────────┘
```

## Storage Design

### KV Namespaces

**1. API_KEYS Namespace**
- Stores API key metadata
- Key format: `<api-key>` (the 5-word phrase itself)
- Value structure:
```json
{
  "expiry": "2024-12-31T23:59:59Z",
  "created": "2024-01-01T00:00:00Z"
}
```

**2. CHATS Namespace**
- Stores chat-to-API-key associations
- Key format: `<chat_id>` (Telegram chat ID)
- Value structure:
```json
{
  "api_key": "correct-horse-battery-staple-zebra",
  "authenticated_at": "2024-01-15T10:30:00Z"
}
```

### Storage Operations
- No TTL set on any KV entries (permanent storage)
- Expiry checking done in application logic
- All dates stored in ISO 8601 format (UTC)

## API Key Design

### Format
- 5 random words from a 2000-word dictionary
- Format: `word1-word2-word3-word4-word5`
- Example: `correct-horse-battery-staple-zebra`
- ~55 bits of entropy

### Generation
- CLI tool generates keys locally
- Bot owner manually adds to KV via Cloudflare dashboard or wrangler CLI
- No API endpoint for key generation (security)

## Authentication Flow

### First-Time Authentication
```
User: "Hello bot"
Bot: "Please authenticate with your API key."
User: "correct-horse-battery-staple-zebra"
Bot: [Validates key exists and not expired]
Bot: [Stores chat_id → api_key association]
Bot: "Authentication successful! How can I help?"
```

### Subsequent Messages
```
User: "Hello again"
Bot: [Checks CHATS KV for existing auth]
Bot: [Validates associated API key not expired]
Bot: "Hello! How can I help?"
```

### Edge Cases
- **Expired key**: "Your API key has expired. Please contact the bot owner for a new key."
- **Invalid key**: "Invalid API key. Please check and try again."
- **Group already authenticated**: "This group is already authenticated."

## Webhook Security

### Implementation
Using Telegram's recommended secret token approach:

1. Generate random secret during bot setup
2. Configure webhook with secret:
```javascript
setWebhook({
  url: "https://zenfast.example.workers.dev/webhook",
  secret_token: "random-secret-token-here"
})
```

3. Validate on every request:
```javascript
if (request.headers.get("X-Telegram-Bot-Api-Secret-Token") !== env.WEBHOOK_SECRET) {
  return new Response("Unauthorized", { status: 401 });
}
```

## Message Processing

### Scope
- **Private chats**: Process all messages after authentication
- **Group chats**: Process all messages after authentication (not just mentions)
- **Channels**: Same as group chats

### Basic Flow
1. Receive webhook from Telegram
2. Validate webhook secret
3. Extract chat_id from message
4. Check authentication status
5. If not authenticated, prompt for API key
6. If authenticated, echo message back (Phase 1 - no commands)

## Environment Configuration

### Cloudflare Worker Environment Variables
```toml
# wrangler.toml
name = "zenfast"

[env.production]
vars = { WEBHOOK_SECRET = "your-secret-here" }

[[kv_namespaces]]
binding = "API_KEYS"
id = "your-kv-namespace-id-1"

[[kv_namespaces]]
binding = "CHATS"
id = "your-kv-namespace-id-2"
```

### Telegram Bot Configuration
- Create bot via @BotFather
- Disable group privacy mode (to see all messages)
- Set webhook URL after deployment

## Deployment Process

1. **Create KV namespaces**:
```bash
wrangler kv:namespace create "API_KEYS"
wrangler kv:namespace create "CHATS"
```

2. **Generate API keys** (via CLI tool):
```bash
node generate-key.js --expiry "2024-12-31"
# Output: correct-horse-battery-staple-zebra
```

3. **Add keys to KV**:
```bash
wrangler kv:key put --namespace-id=xxx "correct-horse-battery-staple-zebra" \
  '{"expiry":"2024-12-31T23:59:59Z","created":"2024-01-01T00:00:00Z"}'
```

4. **Deploy worker**:
```bash
wrangler deploy
```

5. **Set webhook**:
```bash
curl https://api.telegram.org/bot<TOKEN>/setWebhook \
  -d "url=https://zenfast.example.workers.dev/webhook" \
  -d "secret_token=your-secret-here"
```

## Error Handling

### Approach
- Return user-friendly error messages via Telegram
- No error logging (privacy, simplicity)
- Let Cloudflare handle infrastructure errors
- Respond with 200 OK even on application errors (Telegram best practice)

### Common Errors
- KV unavailable: "Service temporarily unavailable. Please try again."
- Invalid message format: Ignore silently
- Webhook validation failure: Return 401 (blocks request)

## Security Considerations

1. **No sensitive data in logs**: Worker doesn't log messages or API keys
2. **HTTPS only**: Enforced by Cloudflare Workers
3. **API key transmission**: One-time via Telegram's encrypted chat
4. **No key enumeration**: Can't list or discover valid keys
5. **Rate limiting**: Rely on Cloudflare's built-in DDoS protection

## Performance Targets

- **Response time**: < 500ms for auth check + echo
- **Cold start**: < 50ms (Workers are fast)
- **Concurrent requests**: 50+ (Workers auto-scale)

## Limitations & Simplifications

1. **No command framework**: Just echo messages after auth
2. **No user management**: Owner manually manages keys
3. **No audit logging**: No tracking of who did what
4. **No key rotation helpers**: Users re-auth manually
5. **No backup/restore**: Rely on KV durability
6. **Single region**: Use Cloudflare's default
7. **No monitoring**: Users report issues directly

## Future Considerations

When extending the bot with actual commands:
1. Add command parsing after auth check
2. Store command state in KV if needed
3. Consider Durable Objects for complex state
4. Add structured logging for debugging

## Summary

This design delivers a minimal but functional authenticated Telegram bot that:
- Meets all PRD requirements
- Costs < $5/month (likely free tier)
- Deploys in minutes
- Requires minimal maintenance
- Provides a foundation for future features

The implementation focuses on getting a working bot quickly while maintaining security and reliability for the target use case of friends and family.